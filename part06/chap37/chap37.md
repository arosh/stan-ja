## 37. 診断モード

<!-- 2.17.0の38章を参照しました。 -->

Stanの診断モードは、Stanプログラムをデータつきで走らせ、乱数で、あるいはユーザーの指定した初期値でパラメーターを初期化し、対数確率とその勾配を評価します。
Stanプログラムによって計算された勾配は、有限差分によって計算された値と比較されます。

診断モードの設定には2つのパラメーターがあります。

| パラメーター | 説明                   | 制約           | デフォルト |
|:-------------|:-----------------------|:---------------|:-----------|
| $\epsilon$   | 有限差分のサイズ       | $\epsilon$ > 0 | 1e-6       |
| error        | マッチングの誤差の閾値 | error > 0      | 1e-6       |

Stanプログラムによる勾配の値と、有限差分による値との差が、指定した閾値よりも大きいときには、その引数にはフラグが立てられます。

### 37.1. 出力

診断モードでは、指定した初期値について、Stanプログラムによって計算された（割合を含めない）対数事後密度が表示されます。また、それぞれのパラメーターについて、そのパラメーターの初期値のもとで、Stanプログラムにより計算された勾配と、有限差分により計算された勾配とが表示されます。有限差分は、Stanのプログラムに対応して、対数確率について計算されます。

#### 制約のないスケール

出力は変数の値について行なわれ、その勾配は、制約のないスケールでのものです。これが意味するのは、各変数は、それを定義するのに必要な、制約のない変数の数に対応するサイズのベクトルであるということです。
たとえば、$N \times n$の相関行列では、$\left(\begin{array}{c} N \\ 2 \end{array}\right)$の制約のないパラメーターが必要です。制約のあるパラメーターから制約のないパラメーターへの変換は、パラメーター宣言での制約に基づいていますが、詳細は34章で述べています。

#### ヤコビアンを含む

変数に宣言された制約により必要となるヤコビアンの補正が対数密度には含まれます。この詳細は34章を参照してください。
ヤコビアンの補正は、実際のところ最適化を使うときにはオフになります。しかし、診断モードでオフにする方法は今のところありません。

### 37.2. 設定オプション

診断モードでの一般的な設定オプションはMCMCのものと同じです。詳細は33.3節を参照してください。
初期値は指定することもできますし、乱数から取ってくることもできます。
乱数発生器の設定は、乱数による初期化が指定されたときにだけ有効になります。

### 37.3. 速度についての警告とデータのトリミング

有限差分を使用するため、計算時間はパラメーターの数に対して線形に増加します。
とりわけ、データのサイズに応じて潜在パラメーターが増えるようなモデルでは、非常に長い時間が必要になります。
そのような場合には、もっと小さなサイズのデータでモデルを診断するのがよいでしょう。
