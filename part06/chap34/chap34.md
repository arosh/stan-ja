<!-- 2.17の35章を訳しました。 -->
## 34. 制約のある変数の変換

サンプリングの際のハミルトニアン・ダイナミクスのシミュレーション中に制約を扱う必要をなくすため、Stanのモデル中の（多変量）パラメーターはすべて、モデルコンパイラーによって、目に見えないうちに制約のない変数に変換されます。
この変換は、パラメーターの定義中に制約があれば、その制約に基づいておこなわれます。
スカラー、あるいはベクトル・行ベクトル・行列中のスカラーには、上限、下限、あるいはその両方の制約をつけることができます。
ベクトルには、順序あるいは正の順序、単体という制約を別につけることができます。
行列には、相関行列あるいは共分散行列という制約をつけることができます。
この章では、それぞれの型の変数に使われる変換の定義について説明します。

StanはモデルをC++のクラスに変換します。このモデルでは、$\mathbb{R}^{K}$全体を台とする確率関数を定義します。ここで$K$は、プログラム中で定義される制約のあるパラメーターを定義するのに必要な、制約のないパラメーターの数です。
このC++のクラスにはまた、制約のないパラメーターを制約つきに変換し、適切なヤコビアンを適用するコードがあります。

### 34.1. 変数変換

確率変数$X$が密度$p_X(x)$をもつときの台とは、非零の密度を持つ値からなる下位集合です。

$$ \mathrm{supp}(X) = \{x \mid p_X(x) > 0\} $$

$f$が、$X$の台で定義される全域関数ならば、$Y=f(X)$は新しい確率変数です。
この節では、行儀のよい変換$f$に対する$Y$の確率密度関数の計算方法をしめします。
この章の後の部分では、Stanで使われる変換について詳しく述べます。

#### 単変量の変数変換

$X$は1次元で、$f:\mathrm{supp}(X)\rightarrow\mathbb{R}$は、1対1の単調関数で、微分可能な逆関数$f^{-1}$を持つとします。
すると、$Y$の密度は次式で与えられます。

$$ p_Y(y) = p_X(f^{-1}(y)) \left| \frac{d}{dy}f^{-1}(y)\right| $$

逆変換の導関数の絶対値は、変換された変数のスケールが、基になる変数に関してどのように変化するのかを測るものとなります。

#### 多変量の変数変換

導関数の絶対値を多変量に一般化したものがヤコビアン、もっと詳しく言うと、変換のヤコビ行列の行列式の絶対値です。
ヤコビ行列は、すべての入力変数に対する各出力変数の変化を測るものです。導関数の絶対値は、それを使って、パラメーター空間において与えられた点での体積の微分変化を決定します。

$X$は$K$次元の確率変数で、その確率密度関数を$p_X(x)$とします。
新しい確率変数$Y=f(X)$は、しかるべく行儀のよい関数$f$により$X$を変換することで定義できます。
それには以下のようになれば十分です。すなわち、$f$が1対1であり、その逆関数$f^{-1}$が矛盾なく定義されたヤコビアンを持つならば、$Y$の密度は次式となります。

$$ p_Y(y) = p_X(f^{-1}(y)) | \mathrm{det} J_{f^{-1}}(y) | $$

ここで、$\mathrm{det}$は行列式演算子で、$J_{f^{-1}}(y)$は、$y$で評価された$f^{-1}$のヤコビ行列です。
$x = f^{-1}$なので、ヤコビ行列は以下のように定義されます。

$$ J_{f^{-1}}(y) = \left[ \begin{array}{ccc}\frac{\partial x_1}{\partial y_1} & \dots & \frac{\partial x1}{\partial y_K} \\ \vdots & \vdots & \vdots \\ \frac{\partial x_K}{\partial y_1} & \dots & \frac{\partial x_K}{\partial y_K} \end{array}\right] $$

もしヤコビ行列が三角行列ならば、行列式は簡単で、対角要素の積となります。

$$ \mathrm{det}J_{f^{-1}}(y) = \prod_{k=1}^{K}\frac{\partial x_k}{\partial y_k} $$

たとえば次元によって変数が順序づけられているような状況や、各変数の変換された値が前の変数の変換された値に依存しているような状況では自然と三角行列になります。
対角行列は三角行列の単純な形ですが、変換された変数のそれぞれが単一の変換されていない変数にのみ依存するときには対角行列になります。

### 34.2. 下限のあるスカラー

Stanでは、下限と上限の変換には対数変換を使います。

#### 下限の変換

変数$X$が下限$a$を持つと宣言されているときには、以下のようにして制約のない変数$Y$に変換されます。

$$ Y = \log(X - a) $$

#### 下限の逆変換

下限の逆変換は、制約のない変数$Y$を、下限$a$のある変数$X$へとマッピングします。

$$ X = \exp(Y) + a $$

#### 下限逆変換の導関数の絶対値

この逆変換の導関数の絶対値は以下のようになります。

$$ \left| \frac{d}{dy}(\exp(y) + a) \right| = \exp(y) $$

したがって、$X$の密度$p_X$が与えられると、$Y$の密度は以下になります。

$$ p_Y(y) = p_X(\exp(y) + a)\cdot\exp(y) $$

### 34.3. 上限のあるスカラー

Stanでは、上限には、変数を負にして対数変換します。

#### 上限の変換

変数$X$が上限$b$を持つと宣言されているときには、以下のようにして制約のない変数$Y$に変換されます。

$$ Y = \log(b - X) $$

#### 上限の逆変換

上限の逆変換は、制約のない変数$Y$を上限$b$のある変数$X$に変換します。

$$ X = b - \exp(Y) $$

#### 上限逆変換の導関数の絶対値

上限の逆変換の導関数の絶対値は以下のようになります。

$$ \left| \frac{d}{dy}(b - \exp(y)) \right| = exp(y) $$

したがって、制約のない変数$Y$の密度は、上限$b$の変数$X$の密度で以下のように定義されます。

$$ p_Y(y) = p_X(b - \exp(y))\cdot\exp(y) $$

### 34.4. 上下限のあるスカラー

上下限のある変数については、Stanでは、スケーリングと平行移動をさせた対数オッズ変換を使います。

#### 対数オッズとロジスティック・シグモイド

対数オッズ関数は$u \in (0,1)$について次式のように定義されます。

$$ \mathrm{logit}(u) = \log\frac{u}{1 - u} $$

対数オッズ関数の逆関数はロジスティック・シグモイドです。$v \in (-\infty,\infty)$について次式のように定義されます。

$$ \mathrm{logit}^{-1}(v) = \frac{1}{1 + \exp(-v)} $$

ロジスティック・シグモイドの導関数は以下です。

$$ \frac{d}{dy}\mathrm{logit}^{-1}(y) = \mathrm{logit}^{-1}(y)\cdot\left(1 - \mathrm{logit}^{-1}(y)\right) $$

#### 上下限の変換

開区間$(a,b)$に制約される変数については、Stanでは、スケーリングと平行移動をさせた対数オッズ変換を使います。
変数$X$が下限$a$と上限$b$を持つと宣言されているときには、以下のように新しい変数$Y$に変換されます。

$$ Y = \mathrm{logit}\left(\frac{X - a}{b - a}\right) $$

#### 上下限の逆変換

この変換の逆変換は次式となります。

$$ X = a + (b - a)\cdot\mathrm{logit}^{-1}(Y) $$

#### 上下限逆変換の導関数の絶対値

この逆変換の導関数の絶対値は次式で与えられます。

$$ \left| \frac{d}{dy}\left(a + (b - a)\cdot\mathrm{logit}^{-1}(y)\right) \right| = (b - a)\cdot\mathrm{logit}^{-1}(y)\cdot\left(1 - \mathrm{logit}^{-1}(y)\right) $$

したがって、変換された変数$Y$の密度は次式となります。

$$ p_Y(y) = p_X\left(a + (b - a)\cdot\mathrm{logit}^{-1}(y)\right) \cdot (b - a) \cdot \mathrm{logit}^{-1}(y) \cdot \left( 1 - \mathrm{logit}^{-1}(y) \right) $$

この式は見た目は複雑ですが、ほとんどの項は繰り返しなので一度だけの評価ですみます。もっとも重要なところですが、$\mathrm{logit}^{-1}(y)$も一度だけの評価で足りるので、$\exp(-y)$を呼び出すのも一度だけです。

### 34.5. 順序のあるベクトル

モデリングの仕事によっては、ベクトル値の確率変数$X$が、順序のある数列となっている必要がある場合があります。
ひとつの例は、順序ロジスティック回帰（9.8節を参照）のカットポイントの集合です。

制約のある項では、順序のある$K$次元ベクトル$x \in \mathbb{R}^K$は$k \in \{1,\dots,K-1\}$について次式を満たします。

$$ x_k < x_{k + 1} $$

#### 順序の変換

Stanの変換は、制約をそのままたどっています。以下のようにして、増加するベクトル$x \in \mathbb{R}^K$を制約のないベクトル$y \in \mathbb{R}^K$にマッピングします。

$$ y_k = \left\{ \begin{array}{ll} x_1 & k = 1\text{のとき} \\[4pt] \log(x_k - x_{k - 1}) & 1 < k \le K\text{のとき} \end{array} \right. $$

#### 順序の逆変換

制約のないベクトル$y \in \mathbb{R}^K$から順序のある数列$x \in \mathbb{R}^K$への逆変換は以下の再帰で定義されます。

$$ x_k = \left\{ \begin{array}{ll} y_1 & k = 1\text{のとき} \\[4pt] x_{k - 1} + \exp(y_k) & 1 < k \le K\text{のとき} \end{array}\right. $$

$x_k$は、再帰を使わずに表現することもできます。

$$ x_k = y_1 + \sum_{k'=2}^{k}\exp(y_{k'}) $$

#### 順序逆変換のヤコビ行列式の絶対値

この逆変換$f^{-1}$のヤコビアンは下三角行列となり、$1 \le k \le K$の対角要素は以下のようになります。

$$ J_{k,k} = \left\{\begin{array}{ll} 1 & k = 1\text{のとき} \\[4pt] \exp(y_k) & 1 < k \le K\text{のとき} \end{array} \right. $$

$J$が三角行列なので、ヤコビ行列式の絶対値は次式となります。

$$ \left| \mathrm{det}J \right| = \left| \prod_{k = 1}^{K}J_{k,k} \right| = \prod_{k=1}^{K}\exp(y_k) $$

すべてをあわせると、$p_X$が$X$の密度ならば、変換した変数$Y$の密度$p_Y$は次式で与えられます。

$$ p_Y(y) = p_X(f^{-1}(y))\prod_{k=1}^{K}\exp(y_k) $$

### 34.6. 単位単体

単位単体に制約される変数は、多変量離散モデルにおいて、（カテゴリカル分布や多項分布の）パラメーターとしても、その事前分布（ディリクレ分布や多変量ロジスティック分布）として生成される変数としても現れます。

単位$K$次元単体は、$x \in \mathbb{R}^K$の点の集合であり、$1 \le k \le K$について、

$$ x_k > 0 $$

であり、かつ

$$ \sum_{k=1}^{K}x_k = 1 $$

です。

別の定義は、頂点の凸包となります。
例えば、2次元では、単体の頂点は極値では$(0,1)$と$(1,0)$で、単位2次元単体はこの2点をつなぐ線上にあります。たとえば、$(0.3,0.7)$や$(0.99,0.01)$のような値はこの線にのっています。
3次元では、基底は$(0,0,1)$、$(0,1,0)$、$(1,0,0)$で、単位3次元単体はその境界と、頂点がつくる3角形の内側にあります。3次元単体の点には、$(0.5,0.5,0)$や$(0.2,0.7,0.1)$など、非負で、合計すると1になる3つの点の組み合わせすべてが含まれます。

この例がしめすように、単体は、$\mathbb{R}^K$から$K-1$次元の下位空間を常に取り出すことができます。
したがって、$K$次元単体の点$x$は、そのはじめの$K-1$個の要素$x_1,x_2,\dots,x_{K-1}$で完全に決まります。

$$ x_K = 1 - \sum_{k=1}^{K-1}x_k $$

#### 単位単体の逆変換

Stanの単位単体の逆変換は、以下の棒折りのメタファー^[超球面座標を用いた、同じ変換の別の導出は、Betancourt 2010を参照してください。]を使うと理解できるでしょう。

> 単位長（すなわち、長さ1）の1本の棒があるとします。
> 一部を折り取り、$x_1$とラベルを付けて別に置きます。
> 次に、残りの一部を折り取り、$x_2$とラベルを付けて別に置きます。
> これを、$(x_1,x_2,\dots,x_{K-1})$とラベルのついた$K-1$個の部分が折り取られるまで続けます。
> 元の棒の最後の残りに$x_K$とラベルを付けます。
> それぞれの部分は非負の長さを持ち、その長さの合計は1ですから、ベクトル$(x_1,x_2,\dots,x_K)$はあきらかに単位単体です。

完全な逆マッピングには、折られる元の棒の$(0,1)$の、どの部分で折るのかを表す必要があります。
この折る比率はそれ自身、上下限のある1次元変数について上で述べた、逆ロジット変換を用いた$(-\infty,\infty)$の制約のない値から導出されます。

より形式的には、中間ベクトル$z \in R^{K-1}$は、その座標$z_k$が、ステップ$k$で折られた棒の割合をしめすとして、$1 \le k < K$の要素ごとに次式で定義されます。

$$ z_k = \mathrm{logit}^{-1}\left( y_k + \log\left(\frac{1}{K - k}\right) \right) $$

上の定義のロジット項$\log\left(\frac{1}{K - k}\right)$（すなわち、$\mathrm{logit}\left(\frac{1}{K-k-1}\right)$）は、ゼロベクトル$y$が単体$x = (1/K,\dots,1/K)$にマッピングされるように変換を調整します。
たとえば、$y_1=0$ならば$z_1=1/K$で、$y_2=0$ならば、$z_2=1/(K-1)$で、$y_{K-1}=0$ならば$z_{K-1}=1/2$です。

折られた割合$z$は、棒のサイズと、$1 \le k < K$についての$x_k$の結果の値を決定するのに使われます。

$$ x_k = \left( 1 - \sum_{k' = 1}^{k - 1} x_{k'} \right) z_k $$

総和項はステージ$k$における元の棒の残りの長さを表します。
これに、折る割合$z_k$をかけると、$x_k$が得られます。
制約のないパラメーターで必要なのは$K-1$個だけで、最後の次元の値$x_k$は元の棒の残りの長さとなります。

$$ x_K = 1 - \sum_{k=1}^{K-1}x_k $$

#### 単位単体の逆変換のヤコビ行列式の絶対値

この逆変換$f^{-1}$のヤコビアン$J$は下三角行列で、対角要素は以下です。

$$ J_{k,k} = \frac{\partial x_k}{\partial y_k} = \frac{\partial x_k}{\partial z_k}\frac{\partial z_k}{\partial y_k} $$

ここで、

$$ \frac{\partial z_k}{\partial y_k} = \frac{\partial}{\partial y_k}\mathrm{logit}^{-1}\left( y_k + \log\left(\frac{1}{K - k}\right) \right) = z_k(1 - z_k) $$

かつ

$$ \frac{\partial x_k}{\partial z_k} = \left( 1 - \sum_{k' = 1}^{k - 1}x_{k'} \right) $$

です。
この定義は再帰的で、$x_1,\dots,x_{k-1}$で$x_k$を定義しています。

$f^{-1}$のヤコビアン$J$は下三角行列で正ですから、その導関数の絶対値は以下のように簡単になります。

$$ | \mathrm{det}J | = \prod_{k=1}^{K-1}J_{k,k} = \prod_{k=1}^{K-1}z_k(1 - z_k)\left( 1 - \sum_{k'=1}^{k-1}x_{k'}\right) $$

すると、変換された値$Y=f(X)$の密度は次式になります。

$$ p_Y(y) = p_X(f^{-1}(y))\prod_{k=1}^{K-1}z_k(1-z_k)\left( 1 - \sum_{k'=1}^{k-1}x_{k'}\right) $$

中間値$z_k$で表現されているにも関わらず、この式はまだ実際よりも複雑に見えます。
指数関数は、制約のないパラメーター$y_k$それぞれについて1回評価されるだけです。
そのほかは、変換にともなって累積的に計算可能な基本代数に過ぎません。

#### 単位単体の変換

変換$Y=f(X)$は、逆変換の段階を逆にすることで導出できます。
逆回しにすると、与えられた折る割合$z$について、$y$は要素ごとに次式で定義されます。

$$ y_k = \mathrm{logit}(z_k) - \log\left(\frac{1}{K - k}\right) $$

折る割合$z_k$は、最初の$k-1$の部分が折られた後で残った長さに対する$x_k$の割合として定義されます。

$$ z_k = \frac{x_k}{1 - \sum_{k'=1}^{k-1}x_{k'}} $$

### 34.7. 単位ベクトル

以下のような単位ユークリッド長の$n$次元ベクトル$x \in \mathbb{R}^n$は単位ベクトルと呼ばれます。

$$ ||x|| = \sqrt{x^{\top}x} = \sqrt{x_1^2 + x_2^2 + \cdots + x_n^2} = 1 $$

#### 単位ベクトルの逆変換

Stanは、制約のないベクトル$y \in \mathbb{R}^n$をそのノルム$||y|| = \sqrt{y^{\top}y}$で割って、単位ベクトル$x$を得ます。

$$ x = \frac{y}{||y||} $$

単位ベクトルを生成するために、Stanは、独立な単位正規分布により$\mathbb{R}^n$でランダムに点を生成します。そして、ユークリッド長で割って標準化します。
Marsaglia (1972)は、この方法で$S^{n-1}$上で一様、ランダムに点が生成されることを示しました。<!-- このSとは? -->
すなわち、$n \in 1:n$について、$y_n \sim \mathrm{Normal}(0, 1)$を抽出すると、$x = \frac{y}{||y||}$は$S^{n-1}$上で一様分布となります。
これにより、$\mathbb{R}^n$で互いに近い点を$S^{n-1}$で互いに近い点にマッピングするよう局所的な隣接関係を保存する、$S^{n-1}$について$n$次元の基底を使うことができます。
このマッピングは完全に距離を保存するものではありません。これは、$\mathbb{R}^n$でじゅうぶんに互いに離れた任意の複数の点が$S^{n-1}$では同一の点になる場合があるからです。

##### 警告: ゼロでは未定義

上の$\mathbb{R}^n$から$S^n$へのマッピングはゼロでは定義されません。
サンプリング中、この点の結果は測度ゼロを持ち、したがって無視される一方、これはデフォルトの初期化点であり、したがって単位ベクトルのパラメーターはゼロでは初期化できません。
単純な回避策は、ゼロのまわりの非常に小さい間隔から初期化することです。これは、Stanのインターフェイスすべてにオプションとして組み込まれています。

#### 単位ベクトル逆変換のヤコビ行列式の絶対値

この入力ベクトル$y$を出力ベクトル$x$に関連づけるヤコビ行列は、すべての非零の入力$y$について$x^{\top}x=1$なので特異です。
したがって、技術的には$x$から$y$への一意な変換はありません。
この問題を回避するためには、$y=rx$となるように$r=\sqrt{y^{\top}y}$と置きます。
$(r,x_{-n})$から$y$への変換はうまく定義されますが、$r$は任意です。そのため、$r=1$とします。
この場合、ヤコビ行列の行列式は$-\frac{1}{2}y^{\top}y$に比例します。これは、独立な$n$次元の標準多変量正規分布のカーネルです。

### 34.8. 相関行列

$K \times K$次元相関行列は対称である必要があります。したがって、すべての$k,k' \in \{1,\dots,K\}$について以下のようになります。

$$ x_{k,k'} = x_{k',k} $$

かつ、単位対角要素を持つ必要があります。したがって、すべての$k \in \{1,\dots,K\}$について以下のようになります。

$$ x_{k,k} = 1 $$

さらに正定値である必要があります。したがってすべての非零の$K$次元ベクトル$a$について以下のようになります。

$$ a^{\top}xa > 0 $$

このいくぶん複雑な制約を扱うために、StanはLewandowski et al. (2009)の変換を実装しています。$K \times K$次元相関行列を特定するために必要な自由パラメーターの数は$\binom{K}{2}$です。

#### 相関行列の逆変換

その$\binom{K}{2}$個のパラメーターから相関行列を生成するという逆変換は非常に簡単に特定できます。
この過程は実際は2段階に分割されます。
まずはじめに$y$は、$\binom{K}{2}$個の制約のない値を含むベクトルとします。
最初に、双射関数$\mathrm{tanh}:\mathbb{R}\rightarrow(0,1)$により変換します。

$$ \tanh x = \frac{\exp(2x) - 1}{\exp(2x) + 1} $$

次に、$K \times K$行列$z$を定義します。変換された値で、この行列の上三角の値を行の並びで埋めます。
たとえば、$4 \times 4$の場合なら$\binom{4}{2}$の値を以下のように並べます。

$$ z = \left[\begin{array}{cccc} 0 & \tanh y_1 & \tanh y_2 & \tanh y_4 \\ 0 & 0 & \tanh y_3 & \tanh y_5 \\ 0 & 0 & 0 & \tanh y_6 \\ 0 & 0 & 0 & 0 \end{array}\right] $$

Lewandowskiらは、双射により配列$z$を相関行列$x$にマッピングする方法を示しました。
$i < j$について、要素$z_{i,j}$は、$i$と$j$との偏正準相関(CPC; canonical partial correlation)と解釈されます。これは、$i$と$j$の両方が$i' < i$となるようなすべての変数$i'$で回帰したときの$i$の残差と$j$の残差との相関です。
$i=1$の場合は、それより前の変数がないので、$z_{1,j}$は単に$i$と$j$とのピアソン相関です。

StanではLKJ変換は、最終的な相関行列のコレスキー因子$w$で再定式化されています。$1 \le i,j \le K$では以下のように定義されます。

$$ w_{i,j} = \left\{\begin{array}{cl} 0 & i > j\text{のとき} \\[4pt] 1 & 1 = i = j\text{のとき} \\[4pt] \prod_{i'=1}^{i-1}\left(1 - z_{i',j}^{2}\right)^{1/2} & 1 < i = j\text{のとき} \\[4pt] z_{i,j} & 1 = i < j\text{のとき} \\[4pt] z_{i,j}\prod_{i'=1}^{i-1}\left(1 - z_{i',j}^2\right)^{1/2} & 1 < i < j\text{のとき} \end{array}\right. $$

ここで、出てくる行列すべてを計算する必要はありません。前の行から行を計算するところは、もっと扱いやすい式にまとめます。

$$ w_{i,j} = \left\{\begin{array}{cl} 0 & i > j\text{のとき} \\[4pt] 1 & 1 = i = j\text{のとき} \\[4pt] z_{i,j} & 1 = i < j\text{のとき} \\[4pt] z_{i,j}\prod_{i'=1}^{i-1}\left(1 - z_{i',j}^2\right)^{1/2} & 1 < i \le j\text{のとき} \end{array}\right. $$

上三角のコレスキー因子$w$が与えられると、最終的な相関行列は次式になります。

$$ x = w^{\top}w $$

Lewandowskiは、相関行列の行列式を偏正準相関で定義できることを示しました。

$$ \mathrm{det} x = \prod_{i=1}^{K-1}\prod_{j=i+1}^{K}(1 - z_{i,j}^2) = \prod_{1 \le i < j \le K}(1 - z_{i,j}^2) $$

#### 相関行列逆変換のヤコビ行列式の絶対値

Lewandowski et al. (2009)の式11の逆変換から、ヤコビ行列式の絶対値は次式となります。

$$ \sqrt{\prod_{i=1}^{K-1}\prod_{j=i+1}^{K}\left(1 - z_{i,j}^2\right)^{K-i-1}} \times \prod_{i=1}^{K-1}\prod_{j=i+1}^{K}\frac{\partial \tanh z_{i,j}}{\partial y_{i,j}} $$

#### 相関行列の変換

相関行列の変換は、前の節で定義された逆変換の手順を逆転させることで定義されます。

相関行列$x$からはじめます。最初の段階では、$x = ww^{\top}$となるような一意な上三角行列$w$を見つけます。$x$は正定値ですから、これは、コレスキー分館を適用することで可能となります。

$$ w = \mathrm{chol}(x) $$

次の段階では、コレスキー因子$w$をCPCの配列$z$に戻しますが、これは、$w$の定義のときの要素で並べると簡単になります。逆のときは以下になります。

$$ z_{i,j} = \left\{\begin{array}{cl} 0 & i \le j\text{のとき} \\[4pt] w_{i,j} & 1 = i < j\text{のとき} \\[4pt] w_{i,j}\prod_{i'=1}^{i-1}\left(1 - z_{i',j}^2\right)^{-2} & 1 < i < j\text{のとき}\end{array}\right. $$

変換の最終段階は双曲線正接変換を戻すところですが、これは次式で定義されます。

$$ \tanh^{-1}v = \frac{1}{2}\log\left(\frac{1+v}{1-v}\right) $$

逆双曲線正接関数$\mathrm{tanh}^{-1}$は、Fisher変換とも呼ばれます。

### 34.9. 共分散行列

$K \times K$行列が対称で正定値なら（定義は前の節を参照してください）、その行列は共分散行列です。
$K \times K$共分散行列を特定するには$K + \binom{K}{2}$個のパラメーターが必要です。

#### 共分散行列の変換

Stanの共分散の変換は、正に制約された対角要素の対数変換で構成されるコレスキー分解に基づいています。^[この節の変換の別の方法として、スケーリングされた相関行列として共分散行列をパラメーター化するという方法があり、これはStanでそのままコーディングできます。任意の$K \times K$共分散行列$\Sigma$は、$K$次元ベクトル$\sigma$と相関行列$\Omega$を使って表すことができます。\\ $$ \Sigma = \mathrm{diag}(\sigma) \times \Omega \times \mathrm{diag}(\sigma)$$ \\ すると、各要素は偏差でスケーリングされた相関となります。\\ $$ \Sigma_{m,n} = \sigma_m \times \sigma_n \times \Omega_{m,n} $$]

$x$が共分散行列（すなわち、対称な正定値行列）のとき、次式のような、対角要素が正の一意な下三角行列$z = \mathrm{chol}(x)$が存在します。これはコレスキー因子と呼ばれます。

$$ x = z z^{\top} $$

コレスキー因子$z$の対角以外の要素に制約はありませんが、$1 \le k \le K$について対角要素$z_{k,k}$は正である必要があります。

この変換を完成させるためには、対角要素を対数変換して、以下のように定義される完全に制約のない下三角行列$y$を生成します。

$$ y_{m,n} = \left\{\begin{array}{cl} 0 & m < n \text{のとき} \\[4pt] \log z_{m,m} & m = n \text{のとき} \\[4pt] z_{m,n} & m > n \text{のとき}\end{array}\right. $$

#### 共分散行列の逆変換

この逆変換は、変換の手順を逆にしたものになります。
制約のない下三角$K \times K$行列$y$が与えられたとき、最初の段階は、対数変換を戻して中間行列$z$を復元することです。

$$ z_{m,n} = \left\{\begin{array}{cl} 0 & m < n \text{のとき} \\[4pt] \exp(y_{m,m}) & m = n \text{のとき} \\[4pt] y_{m,n} & m > n \text{のとき} \end{array}\right. $$

共分散行列$x$は、以下のようにコレスキー因子$z$から復元されます。

$$ x = z z^{\top} $$

#### 共分散行列逆変換のヤコビ行列式の絶対値

このときのヤコビアンは、制約のない下三角行列$y$から、対角要素が正の行列$z$への指数変換のヤコビアンと、コレスキー因子$z$から$x$への積変換のヤコビアンとの積となります。

制約のない$y$からコレスキー因子$z$への変換は対角ヤコビ行列を持ちます。その行列式の絶対値は以下のようになります。

$$ \prod_{k=1}^{K}\frac{\partial}{\partial_{y_{k,k}}}\exp(y_{k,k}) = \prod_{k=1}^{K}\exp(y_{k,k}) = \prod_{k=1}^{K}z_{k,k} $$

2番目の、コレスキー因子$z$から共分散行列$x$への変換のヤコビ行列も、$m \ge n$のペア$(m, n)$に対応する対角要素が次式で定義される三角行列です。

$$ \frac{\partial}{\partial z_{m,n}}\left(z z^\top\right)_{m,n} = \frac{\partial}{\partial z_{m,n}}\left(\sum_{k=1}^{K}z_{m,k}z_{n,k}\right) = \left\{\begin{array}{cl} 2 z_{n,n} & m = n \text{のとき} \\[4pt] z_{n,n} & m > n \text{のとき}\end{array}\right. $$

2番目の変換のヤコビ行列式の絶対値は以下のようになります。

$$ 2^K \prod_{m=1}^{K}\prod_{n=1}^{m}z_{n,n} = \prod_{n=1}^{K}\prod_{m=n}^{K}z_{n,n} = 2^K \prod_{k=1}^{K}z_{k,k}^{K-k+1} $$

最後に、制約のない下三角行列$y$から、対称な正定値行列$x$への共分散行列の変換の逆変換の、完全なヤコビ行列式の絶対値は、指数化と積変換のヤコビ行列式の席となります。

$$ \left(\prod_{k=1}^{K}z_{k,k}\right)\left(2^K \prod_{k=1}^{K}z_{k,k}^{K-k+1}\right) = 2^K \prod_{k=1}^{K} z_{k,k}^{K-k+2} $$

$f^{-1}$を、$K + \binom{K}{2}$次元ベクトル$y$から$K \times K$共分散行列$x$への逆変換とします。
$K \times K$共分散行列について定義される密度関数$p_X(x)$は、$K + \binom{K}{2}$次元ベクトル$y$についての$p_Y(y)$の密度に変換されます。

$$ p_Y(y) = p_X(f^{-1}(y)) 2^K \prod_{k=1}^{K}z_{k,k}^{K-k+2} $$

### 34.10. 共分散行列のコレスキー因子

$M \times M$共分散行列$\Sigma$はコレスキー分解して、$LL^{\top}$となるような下三角行列$L$にできます。
$\Sigma$が正定値ならば、$L$は$M \times M$です。
$\Sigma$が半正定値ならば、$L$は$M \times N$で、$N < M$です。

ある行列が、ある共分散行列についてコレスキー因子であるのは、その行列が下三角行列で、対角要素が正で、$M \ge N$であるる場合のみです。
この条件を満たす行列は、$M > N$ならば$LL^{\top}$が半正定値となり、$M = N$であれば正定値となることが保証されます。

共分散行列のコレスキー因子には、$N + \binom{N}{2} + (M - N) N$個の制約のないパラメーターが必要です。

#### 共分散行列のコレスキー因子の変換

Stanのコレスキー因子の変換に必要なのは、共分散行列の変換の最初の段階だけです。すなわち、正の対角要素の対数変換です。
$x$を$M \times N$のコレスキー因子とします。
上三角要素はゼロで、対角要素は正で、下三角には制約はありません。
必要な変換は以下のようになります。

$$ y_{m,n} = \left\{\begin{array}{cl} 0 & m < n \text{のとき} \\[4pt] \log x_{m,m} & m = n \text{のとき} \\[4pt] x_{m,n} & m > n \text{のとき}\end{array}\right. $$

#### 共分散行列のコレスキー因子の逆変換

この逆変換に必要なのは、指数化を対数に戻すことだけです。
$y$が制約のない行列表現とすると、制約のある行列$x$の要素は以下で定義されます。

$$ x_{m,n} = \left\{\begin{array}{cl} 0 & m < n \text{のとき} \\[4pt] \exp(y_{m,m}) & m = n \text{のとき} \\[4pt] y_{m,n} & m > n \text{のとき}\end{array}\right. $$

#### 共分散行列コレスキー因子逆変換のヤコビ行列式の絶対値

この変換は対角ヤコビ行列を持ちます。その行列式の絶対値は以下です。

$$ \prod_{n=1}^{N}\frac{\partial}{\partial_{y_{n,n}}}\exp(y_{n,n}) = \prod_{n=1}^{N}\exp(y_{n,n}) = \prod_{n=1}^{N}x_{n,n} $$

$x = f^{-1}(y)$を、$N + \binom{N}{2} + (M - N) N$ベクトルから、前の節で定義された共分散行列$x$の$M \times N$コレスキー因子への逆変換とします。
共分散行列の$M \times N$コレスキー因子について定義される密度関数$p_X(x)$は、$N + \binom{N}{2} + (M - N) N$ベクトル$y$についての密度$p_Y(y)$に変換されます。

$$ p_Y(y) = p_X(f^{-1}(y))\prod_{n=1}^{N}x_{n,n} $$

### 34.11. 相関行列のコレスキー因子

$K \times K$相関行列$\Omega$は正定値で、単位対角要素を持ちます。
正定値なので、$\Omega=LL^{\top}$となるような、正の対角要素を持つ$K \times K$下三角行列$L$にコレスキー分解できます。
相関行列は単位対角要素を持つので、

$$ \Omega_{k,k} = L_k L_k^\top = 1 $$

コレスキー因子の行ベクトル$L_k$は単位長を持ちます。
この長さと正の制約とにより、$L$の対角要素は、非対角要素から計算できます。そして、$K \times K$相関行列のコレスキー因子には$\binom{K}{2}$だけの制約のないパラメーターが必要となります。

#### 相関行列のコレスキー因子の逆変換

$\binom{K}{2}$個の制約のないパラメーター$y$から、$K \times K$下三角行列のコレスキー因子$x$への逆変化から始めるのが簡単です。
この逆変換は、双曲正接関数tanhに基づきます。この関数は$\mathrm{tanh}(x) \in \{-1,1\}$を満たします。
ここでは、潜在する偏正準相関の方向をとりだすときの、符号付き逆ロジットと同様に機能します（偏正準相関と相関行列のコレスキー因子との関係についてさらに知るには34.8節を参照してください）。

$y$を、$\binom{K}{2}$の制約のない値を持つベクトルとします。
$z$を、対角要素がゼロで、対角より下の要素が行順に埋められている下三角行列とします。
たとえば、$3 \times 3$の場合は以下のようになります。

$$ z = \left[\begin{array}{ccc} 0 & 0 & 0 \\ \tanh y_1 & 0 & 0 \\ \tanh y_2 & \tanh y_3 & 0 \end{array}\right] $$

行列$z$は、要素が$(-1,1)$の範囲にあり、以下のようにしてコレスキー因子$x$に変換されます。^[便利のため、$\sum_{j'<1}x_{i,j'}$のような、項のない総和は0と定義します。これは、$x_{1,1}=1$と、$i>1$について$x_{i,1}=z_{i,1}$であることを意味します。]

$$ x_{i,j} = \left\{\begin{array}{ll} 0 & i < j \text{のとき（対角より上）} \\[12pt] \sqrt{1 - \sum_{j'<j}x_{i,j'}^2} & i = j \text{のとき（対角）} \\[12pt] z_{i,j}\sqrt{1 - \sum_{j'<j}x_{i,j'}^2} & i > j \text{のとき（対角より下）}\end{array}\right] $$

$3 \times 3$の場合は以下のようになります。

$$ x = \left[\begin{array}{ccc} 1 & 0 & 0 \\[6pt] z_{2,1} & \sqrt{1 - x_{2,1}^2} & 0 \\[6pt] z_{3,1} & z_{3,2}\sqrt{1 - x_{3,1}^2} & \sqrt{1 - (x_{3,1}^2 + x_{3,2}^2)}\end{array}\right] $$

ここで、$z_{i,j} \in (-1, 1)$はtanhで変換されたyです。

この方法は、二次（ユークリッド長）スケールの符号付き棒折り過程です。
$j=1$での長さ1から始めて、各下三角要素$x_{i,j}$は、折っている行での残った長さに対する（符号付き）割合$z_{i,j}$で決定されます。
対角要素$x_{i,j}$は、その行のより前の要素で折った残りとなります。
対角より上の要素はゼロです。

#### 相関行列のコレスキー因子の変換

$x$を、何らかの相関行列の$K \times K$コレスキー因子とします。
変換の最初の段階は中間値$z$を$x$から復元することです。

$$ z_{i,j} = \frac{x_{i,j}}{\sqrt{1 - \sum_{j'<j}x_{i,j'}^2}} $$

結果の$z$から$y$へのマッピングは逆tanhです。

$$ y = \tanh^{-1}z = \frac{1}{2}(\log(1 + z) - \log(1 - z)) $$

#### 逆変換のヤコビ行列式の絶対値

完全な変換のヤコビアンは、部分変換のヤコビアンの積です。

まず、逆変換$z = \mathrm{tanh}y$について、その導関数は次式です。

$$ \frac{d}{dy}\tanh y = \frac{1}{(\cosh y)^2} $$

次に、$z$の$x$への逆変換について、結果のヤコビ行列$J$は$\binom{K}{2} \times {K}{2}$次元を持ちます。インデックスは$(i, j)$で、$(i > j)$です。
ヤコビ行列は下三角ですから、行列式は対角要素の積です。$(i, j)$のペアのそれぞれについて対角要素はひとつです。

$$ |\mathrm{det} J| = \prod_{i>j}\left| \frac{d}{dz_{i,j}}x_{i,j}\right| $$

ここで、

$$ \frac{d}{dz_{i,j}}x_{i,j} = \sqrt{1 - \sum_{j'<j}x_{i,j'}^2} $$

です。

制約のない$y$について、組み合わせた密度は次式となります。

$$ p_Y(y) = p_X(f^{-1}(y))\prod_{n < \binom{K}{2}}\frac{1}{(\cosh y)^2}\prod_{i>j}\left(1 - \sum_{j'<j}x_{i,j'}^2\right)^{1/2} $$

ここで、$x=f^{-1}(y)$は記述の簡便性のために使っています。完全な逆変換$x = f^{-1}(y)$の対数ヤコビ行列式は次式で与えられます。

$$ \log |\mathrm{det} J| = -2\sum_{n < \binom{K}{2}}\log\cosh y + \frac{1}{2}\sum_{i>j}\log\left(1 - \sum_{j'<j}x_{i,j'}^2\right) $$
